<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 id="dashboard-title" class="mb-1">
                        <i class="bi bi-graph-up me-2"></i>All Results Summary Dashboard
                    </h4>
                    <p class="text-muted mb-0">Compare and analyze CQL test results across multiple files</p>
                </div>
                <button id="back-to-home-btn" class="btn btn-outline-secondary" (click)="onBackToIndex()">
                    <i class="bi bi-arrow-left me-2"></i>Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    @if (isLoading()) {
        <div id="loading-state" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading test results...</p>
        </div>
    }

    <!-- Error State -->
    @if (errorMessage()) {
        <div id="error-state" class="alert alert-danger" role="alert">
            <h6 class="alert-heading">Error</h6>
            <p class="mb-0">{{ errorMessage() }}</p>
        </div>
    }

    <!-- Dashboard Content -->
    @if (!isLoading() && !errorMessage()) {
        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Engine Comparison Chart -->
            <div class="col-md-6">
                <div id="engine-comparison-chart" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Results by Engine</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="engine-chart-canvas" baseChart [data]="fileComparisonChartData()" [options]="fileComparisonChartOptions"
                                type="bar">
                            </canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Chart -->
            <div class="col-md-6">
                <div id="summary-chart" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Aggregated Summary</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="summary-chart-canvas" baseChart [data]="summaryChartData()" [options]="summaryChartOptions"
                                type="doughnut">
                            </canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Controls Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="filters-controls-card" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Filters & Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Left Column: File Selection and Controls -->
                            <div class="col-md-4">
                                <!-- File Selection -->
                                <div id="file-selection-section" class="mb-4">
                                    <label class="form-label">Files to Include:</label>
                                    <div class="mb-2">
                                        <button id="select-all-btn" class="btn btn-sm btn-outline-primary me-2"
                                            (click)="onSelectAllFiles()">Select All</button>
                                        <button id="deselect-all-btn" class="btn btn-sm btn-outline-secondary"
                                            (click)="onDeselectAllFiles()">Deselect All</button>
                                    </div>
                                    @for (item of dashboardData(); track item.filename) {
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" [id]="'file-' + item.filename"
                                                [checked]="selectedFiles().includes(item.filename)"
                                                (change)="onFileSelectionChange(item.filename, $event.target.checked)">
                                            <label class="form-check-label" [for]="'file-' + item.filename">
                                                {{ item.filename }}
                                            </label>
                                        </div>
                                    }
                                </div>
                            </div>
                            <div class="col-md-4">

                                <!-- Status Filter -->
                                <div class="form-floating mb-3">
                                    <select id="status-filter" class="form-select" [ngModel]="statusFilter()"
                                        (ngModelChange)="onStatusFilterChange($event)">
                                        <option value="all">All Statuses</option>
                                        <option value="pass">Has Passes</option>
                                        <option value="fail">Has Failures</option>
                                        <option value="skip">Has Skips</option>
                                        <option value="error">Has Errors</option>
                                    </select>
                                    <label for="status-filter">Status Filter</label>
                                </div>

                                <!-- Sort Options -->
                                <div class="form-floating mb-3">
                                    <select id="sort-by" class="form-select" [ngModel]="sortBy()"
                                        (ngModelChange)="onSortChange($event)">
                                        <option value="filename">Filename</option>
                                        <option value="passCount">Pass Count</option>
                                        <option value="failCount">Fail Count</option>
                                        <option value="totalTests">Total Tests</option>
                                        <option value="timestamp">Timestamp</option>
                                    </select>
                                    <label for="sort-by">Sort By</label>
                                </div>

                                <!-- Sort Order -->
                                <div class="mb-3">
                                    <button id="sort-order-btn" class="btn btn-outline-secondary w-100" (click)="onSortOrderChange()">
                                        <i class="bi" [class.bi-sort-alpha-down]="sortOrder() === 'asc'"
                                            [class.bi-sort-alpha-up]="sortOrder() === 'desc'"></i>
                                        {{ sortOrder() === 'asc' ? 'Ascending' : 'Descending' }}
                                    </button>
                                </div>
                            </div>

                            <!-- Right Column: Summary Cards -->
                            <div class="col-md-4">
                                <div id="summary-cards-row" class="row">
                                    <div class="col-6 mb-3">
                                        <div id="total-passed-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-success">{{ totalPass() }}</h5>
                                                <p class="card-text">Total Passed</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div id="total-failed-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-danger">{{ totalFail() }}</h5>
                                                <p class="card-text">Total Failed</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div id="total-skipped-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-warning">{{ totalSkip() }}</h5>
                                                <p class="card-text">Total Skipped</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div id="total-errors-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-secondary">{{ totalError() }}</h5>
                                                <p class="card-text">Total Errors</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Results Table -->
        <div class="row">
            <div class="col-12">
                <div id="detailed-results-card" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Detailed Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="results-table" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th id="engine-header" class="fw-bold text-primary" style="cursor: pointer;" (click)="onSortBy('engine')" title="Click to sort by Engine">
                                            Engine
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'engine' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'engine' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="filename-header" style="cursor: pointer;" (click)="onSortBy('filename')" title="Click to sort by Filename">
                                            Filename
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'filename' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'filename' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="timestamp-header" style="cursor: pointer;" (click)="onSortBy('timestamp')" title="Click to sort by Timestamp">
                                            Timestamp
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'timestamp' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'timestamp' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="pass-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('passCount')" title="Click to sort by Pass Count">
                                            Pass
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'passCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'passCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="fail-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('failCount')" title="Click to sort by Fail Count">
                                            Fail
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'failCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'failCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="skip-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('skipCount')" title="Click to sort by Skip Count">
                                            Skip
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'skipCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'skipCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="error-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('errorCount')" title="Click to sort by Error Count">
                                            Error
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'errorCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'errorCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="total-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('totalTests')" title="Click to sort by Total Tests">
                                            Total
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'totalTests' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'totalTests' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="actions-header" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (item of filteredData(); track item.filename) {
                                        <tr>
                                            <td class="fw-bold text-primary" style="cursor: pointer;"
                                                (click)="onViewFile(item.filename)" title="Click to view file details">
                                                <i class="bi bi-gear-fill me-2"></i>
                                                {{ item.engine }}
                                            </td>
                                            <td>
                                                <i class="bi bi-file-earmark-json me-2"></i>
                                                {{ item.filename }}
                                            </td>
                                            <td>
                                                <small>{{ item.timestamp | date:'short' }}</small>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-success">{{ item.summary.passCount }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-danger">{{ item.summary.failCount }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-warning">{{ item.summary.skipCount }}</span>
                                            </td>
                                            <td class="text-center">
                                                <span class="badge bg-secondary">{{ item.summary.errorCount }}</span>
                                            </td>
                                            <td class="text-center">
                                                <strong>{{ item.summary.passCount + item.summary.failCount +
                                                    item.summary.skipCount + item.summary.errorCount }}</strong>
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-sm btn-outline-primary view-file-btn"
                                                    (click)="onViewFile(item.filename)">
                                                    <i class="bi bi-eye me-1"></i>View
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Matrix Section -->
        <div class="row mt-4">
            <div class="col-12">
                <div id="comparison-matrix-card" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>Comparison Matrix
                        </h5>
                        <small class="text-muted">Compare test results with the same name and group across different files</small>
                    </div>
                    
                    <!-- Matrix Controls -->
                    <div class="card-body border-bottom">
                        <div class="row g-3">
                            <!-- Search -->
                            <div class="col-md-3">
                                <div class="form-floating">
                                    <input id="matrix-search" type="text" class="form-control" 
                                           placeholder="Search tests..." 
                                           [ngModel]="matrixSearchTerm()"
                                           (ngModelChange)="onMatrixSearchChange($event)">
                                    <label for="matrix-search">
                                        <i class="bi bi-search me-1"></i>Search Tests
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Group Filter -->
                            <div class="col-md-2">
                                <div class="form-floating">
                                    <select id="matrix-group-filter" class="form-select" 
                                            [ngModel]="matrixGroupFilter()"
                                            (ngModelChange)="onMatrixGroupFilterChange($event)">
                                        <option value="all">All Groups</option>
                                        @for (group of availableGroups(); track group) {
                                            <option [value]="group">{{ group }}</option>
                                        }
                                    </select>
                                    <label for="matrix-group-filter">Group</label>
                                </div>
                            </div>
                            
                            <!-- Status Filter -->
                            <div class="col-md-2">
                                <div class="form-floating">
                                    <select id="matrix-status-filter" class="form-select" 
                                            [ngModel]="matrixStatusFilter()"
                                            (ngModelChange)="onMatrixStatusFilterChange($event)">
                                        <option value="all">All Statuses</option>
                                        <option value="pass">Has Passes</option>
                                        <option value="fail">Has Failures</option>
                                        <option value="skip">Has Skips</option>
                                        <option value="error">Has Errors</option>
                                    </select>
                                    <label for="matrix-status-filter">Status</label>
                                </div>
                            </div>
                            
                            <!-- Consistency Filter -->
                            <div class="col-md-2">
                                <div class="form-floating">
                                    <select id="matrix-consistency-filter" class="form-select" 
                                            [ngModel]="matrixConsistencyFilter()"
                                            (ngModelChange)="onMatrixConsistencyFilterChange($event)">
                                        <option value="all">All Results</option>
                                        <option value="consistent">Consistent</option>
                                        <option value="inconsistent">Inconsistent</option>
                                        <option value="no-data">No Data</option>
                                    </select>
                                    <label for="matrix-consistency-filter">Consistency</label>
                                </div>
                            </div>
                            
                            <!-- Sort Options -->
                            <div class="col-md-2">
                                <div class="form-floating">
                                    <select id="matrix-sort-by" class="form-select" 
                                            [ngModel]="matrixSortBy()"
                                            (ngModelChange)="onMatrixSortChange($event)">
                                        <option value="groupName">Group Name</option>
                                        <option value="testName">Test Name</option>
                                        <option value="consistency">Consistency</option>
                                        <option value="resultCount">Result Count</option>
                                    </select>
                                    <label for="matrix-sort-by">Sort By</label>
                                </div>
                            </div>
                            
                            <!-- Sort Order, Clear & Download -->
                            <div class="col-md-1">
                                <div class="d-flex flex-column gap-2">
                                    <button id="matrix-sort-order-btn" class="btn btn-outline-secondary" 
                                            (click)="onMatrixSortOrderChange()" 
                                            title="Toggle sort order">
                                        <i class="bi" [class.bi-sort-alpha-down]="matrixSortOrder() === 'asc'"
                                           [class.bi-sort-alpha-up]="matrixSortOrder() === 'desc'"></i>
                                    </button>
                                    <button id="clear-matrix-filters-btn" class="btn btn-outline-danger btn-sm" 
                                            (click)="clearMatrixFilters()" 
                                            title="Clear all filters">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Download Dropdown -->
                            <div class="col-md-1">
                                <div class="dropdown">
                                    <button id="matrix-download-btn" class="btn btn-outline-success dropdown-toggle" 
                                            type="button" data-bs-toggle="dropdown" 
                                            aria-expanded="false" title="Download data">
                                        <i class="bi bi-download me-1"></i>
                                        Download
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <button class="dropdown-item" (click)="downloadMatrixAsCsv()">
                                                <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                                                Download as CSV
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item" (click)="downloadMatrixAsJson()">
                                                <i class="bi bi-file-earmark-code me-2"></i>
                                                Download as JSON
                                            </button>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Results Count -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <small class="text-muted">
                                    Showing {{ comparisonMatrix().length }} test(s)
                                    @if (matrixSearchTerm() || matrixGroupFilter() !== 'all' || matrixStatusFilter() !== 'all' || matrixConsistencyFilter() !== 'all') {
                                        <span class="text-warning">(filtered)</span>
                                    }
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        @if (comparisonMatrix().length === 0) {
                            <div class="text-center py-4">
                                <i class="bi bi-info-circle text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2">No tests found for comparison</p>
                                <p class="text-muted">Load test result files to see comparison matrix</p>
                            </div>
                        } @else {
                            <table id="comparison-matrix-table" class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th id="group-header" class="fw-bold" style="cursor: pointer;" 
                                                (click)="onMatrixSortBy('groupName')" 
                                                title="Click to sort by Group">
                                                Group
                                                <i class="bi ms-1" 
                                                   [class.bi-sort-alpha-down]="matrixSortBy() === 'groupName' && matrixSortOrder() === 'asc'" 
                                                   [class.bi-sort-alpha-up]="matrixSortBy() === 'groupName' && matrixSortOrder() === 'desc'"></i>
                                            </th>
                                            <th id="test-name-header" class="fw-bold" style="cursor: pointer;" 
                                                (click)="onMatrixSortBy('testName')" 
                                                title="Click to sort by Test Name">
                                                Test Name
                                                <i class="bi ms-1" 
                                                   [class.bi-sort-alpha-down]="matrixSortBy() === 'testName' && matrixSortOrder() === 'asc'" 
                                                   [class.bi-sort-alpha-up]="matrixSortBy() === 'testName' && matrixSortOrder() === 'desc'"></i>
                                            </th>
                                            @for (fileData of filesForComparison(); track fileData.filename) {
                                                <th id="engine-{{ fileData.filename }}-header" class="text-center">
                                                    <div class="d-flex flex-column align-items-center">
                                                        <span class="fw-bold text-primary">{{ fileData.engine }}</span>
                                                        <small class="text-muted">{{ fileData.filename }}</small>
                                                    </div>
                                                </th>
                                            }
                                            <th id="consistency-header" class="text-center" style="cursor: pointer;" 
                                                (click)="onMatrixSortBy('consistency')" 
                                                title="Click to sort by Consistency">
                                                Consistency
                                                <i class="bi ms-1" 
                                                   [class.bi-sort-alpha-down]="matrixSortBy() === 'consistency' && matrixSortOrder() === 'asc'" 
                                                   [class.bi-sort-alpha-up]="matrixSortBy() === 'consistency' && matrixSortOrder() === 'desc'"></i>
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (test of comparisonMatrix(); track test.groupName + '::' + test.testName) {
                                            <tr>
                                                <td class="fw-bold text-primary">
                                                    <i class="bi bi-folder me-2"></i>{{ test.groupName }}
                                                </td>
                                                <td class="fw-bold">
                                                    <i class="bi bi-play-circle me-2"></i>{{ test.testName }}
                                                </td>
                                                @for (fileData of filesForComparison(); track fileData.filename) {
                                                    <td class="text-center">
                                                        @let result = getTestResultForFile(test, fileData.filename);
                                                        @if (result) {
                                                            <div class="d-flex flex-column align-items-center">
                                                                <span class="badge {{ getStatusBadgeClass(result.testStatus) }} mb-1" 
                                                                      [title]="getResultTooltip(result)">
                                                                    <i class="bi {{ getStatusIcon(result.testStatus) }} me-1"></i>
                                                                    {{ result.testStatus.toUpperCase() }}
                                                                </span>
                                                            </div>
                                                        } @else {
                                                            <span class="text-muted">
                                                                <i class="bi bi-dash-circle me-1"></i>
                                                                <small>Not Found</small>
                                                            </span>
                                                        }
                                                    </td>
                                                }
                                                <td class="text-center">
                                                    @let consistency = getConsistencyStatus(test);
                                                    <span class="badge {{ consistency.badgeClass }}">
                                                        <i class="bi {{ consistency.icon }} me-1"></i>
                                                        {{ consistency.text }}
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>