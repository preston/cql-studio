<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="my-4">
        <h4 class="mb-2">
          <i class="bi bi-upload me-2"></i>FHIR Uploader
        </h4>
        <p class="text-muted">Upload FHIR Bundle resources to a FHIR server</p>
      </div>
      <!-- FHIR Base URL Configuration -->
      <div class="row mb-4">
        <div class="col-md-8">
          <div class="form-floating">
            <input type="url" class="form-control" id="fhirBaseUrl" [value]="getEffectiveFhirBaseUrl()" readonly>
            <label for="fhirBaseUrl">FHIR Base URL</label>
          </div>
          <div class="form-text">
            <i class="bi bi-info-circle me-1"></i>
            Configure FHIR server settings in 
            <a href="#" (click)="navigateToSettings($event)" class="text-decoration-none">
              <i class="bi bi-gear me-1"></i>Application Settings
            </a>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="continueOnError" [(ngModel)]="continueOnError">
            <label class="form-check-label" for="continueOnError">
              Continue on Error
            </label>
          </div>
        </div>
      </div>

      <!-- File Drop Zones -->
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="drop-zone" [class.drag-over]="isDragOver()" (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
            <div class="text-center py-5">
              <i class="bi bi-cloud-upload display-1 text-muted"></i>
              <h4 class="mt-3">Drop FHIR JSON files here</h4>
              <p class="text-muted">or</p>
              <input type="file" id="fileInput" class="d-none" multiple accept=".json" (change)="onFileSelect($event)">
              <label for="fileInput" class="btn btn-primary">
                <i class="bi bi-folder2-open me-2"></i>Choose JSON Files
              </label>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="drop-zone cql-drop-zone" [class.drag-over]="isCqlDragOver()" (dragover)="onCqlDragOver($event)"
            (dragleave)="onCqlDragLeave($event)" (drop)="onCqlDrop($event)">
            <div class="text-center py-5">
              <i class="bi bi-file-code display-1 text-muted"></i>
              <h4 class="mt-3">Drop CQL files here</h4>
              <p class="text-muted">or</p>
              <input type="file" id="cqlFileInput" class="d-none" multiple accept=".cql" (change)="onCqlFileSelect($event)">
              <label for="cqlFileInput" class="btn btn-success">
                <i class="bi bi-folder2-open me-2"></i>Choose CQL Files
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- File List -->
      @if (files().length > 0 || cqlFiles().length > 0) {
      <div class="mb-4">
        <div class="d-flex align-items-center mb-3">
          <h5 class="mb-0 me-2">Selected Files ({{ files().length + cqlFiles().length }})</h5>
          <button type="button" class="btn btn-outline-secondary btn-sm me-3" (click)="toggleAllFiles()">
            <i class="bi bi-toggle-on"></i>Toggle All
          </button>
        </div>
        <div class="list-group">
          @for (file of files(); track file.id) {
           <div class="list-group-item file-item"
             [class.dragging]="draggedFileId() === file.id"
             [class.drag-over]="draggedFileId() && draggedFileId() !== file.id" draggable="true"
             (dragstart)="onFileDragStart($event, file.id)" (dragover)="onFileDragOver($event, file.id)"
             (drop)="onFileDrop($event, file.id)" (dragend)="onFileDragEnd()">
             <div class="d-flex justify-content-between align-items-center">
               <div class="d-flex align-items-center">
                 <i class="bi bi-grip-vertical me-3 text-primary drag-handle" title="Drag to reorder"
                   style="font-size: 1.2rem;"></i>
                 <div class="form-check form-switch me-3">
                   <input class="form-check-input" type="checkbox" [id]="'fileToggle_' + file.id" [checked]="file.enabled"
                     (change)="toggleFileEnabled(file.id)">
                 </div>
                 <div>
                   <div class="fw-bold">{{ file.name }}</div>
                   <small class="text-muted">{{ formatFileSize(file.size) }}</small>
                   @if (file.error) {
                   <div class="text-danger small">{{ file.error }}</div>
                   }
                 </div>
               </div>
               <div class="d-flex align-items-center">
                 @if (file.uploadResult) {
                   <div class="d-flex align-items-center me-3">
                     <i class="bi me-2" [class.bi-check-circle-fill]="file.uploadResult.success" [class.bi-x-circle-fill]="!file.uploadResult.success" [class.text-success]="file.uploadResult.success" [class.text-danger]="!file.uploadResult.success"></i>
                     @if (file.uploadResult.success) {
                       <small class="text-success me-2">Upload successful</small>
                       <i class="bi bi-chevron-down" [class.rotated]="isResultExpanded(file.id)" style="cursor: pointer;" (click)="toggleResultExpansion(file.id)"></i>
                     } @else {
                       <small class="text-danger">{{ file.uploadResult.error }}</small>
                     }
                   </div>
                 }
                 <div class="btn-group" role="group">
                   <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveFileUp(file.id)"
                     [disabled]="files().indexOf(file) === 0">
                     <i class="bi bi-arrow-up"></i>
                   </button>
                   <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveFileDown(file.id)"
                     [disabled]="files().indexOf(file) === files().length - 1">
                     <i class="bi bi-arrow-down"></i>
                   </button>
                   <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeFile(file.id)">
                     <i class="bi bi-trash"></i>
                   </button>
                 </div>
               </div>
             </div>
             
             <!-- Expanded Server Response -->
             @if (isResultExpanded(file.id) && file.uploadResult?.success && file.uploadResult?.result) {
             <div class="mt-3 pt-3 border-top">
               <h6 class="text-muted mb-2">Server Response:</h6>
               <pre class="bg-light p-3 rounded small" style="max-height: 300px; overflow-y: auto;">{{ formatJsonResponse(file.uploadResult?.result) }}</pre>
             </div>
             }
           </div>
          }
          
          <!-- CQL Files -->
          @for (cqlFile of cqlFiles(); track cqlFile.id) {
           <div class="list-group-item file-item cql-file-item"
             [class.dragging]="draggedFileId() === cqlFile.id"
             [class.drag-over]="draggedFileId() && draggedFileId() !== cqlFile.id" draggable="true"
             (dragstart)="onFileDragStart($event, cqlFile.id)" (dragover)="onFileDragOver($event, cqlFile.id)"
             (drop)="onFileDrop($event, cqlFile.id)" (dragend)="onFileDragEnd()">
             <div class="d-flex justify-content-between align-items-center">
               <div class="d-flex align-items-center">
                 <i class="bi bi-grip-vertical me-3 text-success drag-handle" title="Drag to reorder"
                   style="font-size: 1.2rem;"></i>
                 <div class="form-check form-switch me-3">
                   <input class="form-check-input" type="checkbox" [id]="'cqlFileToggle_' + cqlFile.id" [checked]="cqlFile.enabled"
                     (change)="toggleCqlFileEnabled(cqlFile.id)">
                 </div>
                 <div>
                   <div class="fw-bold">
                     <i class="bi bi-file-code me-2 text-success"></i>{{ cqlFile.name }}
                   </div>
                   <small class="text-muted">{{ formatFileSize(cqlFile.size) }} â€¢ CQL Library</small>
                   @if (cqlFile.error) {
                   <div class="text-danger small">{{ cqlFile.error }}</div>
                   }
                 </div>
               </div>
               <div class="d-flex align-items-center">
                 @if (cqlFile.uploadResult) {
                   <div class="d-flex align-items-center me-3">
                     <i class="bi me-2" [class.bi-check-circle-fill]="cqlFile.uploadResult.success" [class.bi-x-circle-fill]="!cqlFile.uploadResult.success" [class.text-success]="cqlFile.uploadResult.success" [class.text-danger]="!cqlFile.uploadResult.success"></i>
                     @if (cqlFile.uploadResult.success) {
                       <small class="text-success me-2">Upload successful</small>
                       <i class="bi bi-chevron-down" [class.rotated]="isResultExpanded(cqlFile.id)" style="cursor: pointer;" (click)="toggleResultExpansion(cqlFile.id)"></i>
                     } @else {
                       <small class="text-danger">{{ cqlFile.uploadResult.error }}</small>
                     }
                   </div>
                 }
                 <div class="btn-group" role="group">
                   <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveCqlFileUp(cqlFile.id)"
                     [disabled]="cqlFiles().indexOf(cqlFile) === 0">
                     <i class="bi bi-arrow-up"></i>
                   </button>
                   <button type="button" class="btn btn-sm btn-outline-secondary" (click)="moveCqlFileDown(cqlFile.id)"
                     [disabled]="cqlFiles().indexOf(cqlFile) === cqlFiles().length - 1">
                     <i class="bi bi-arrow-down"></i>
                   </button>
                   <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeCqlFile(cqlFile.id)">
                     <i class="bi bi-trash"></i>
                   </button>
                 </div>
               </div>
             </div>
             
             <!-- Expanded Server Response -->
             @if (isResultExpanded(cqlFile.id) && cqlFile.uploadResult?.success && cqlFile.uploadResult?.result) {
             <div class="mt-3 pt-3 border-top">
               <h6 class="text-muted mb-2">Server Response:</h6>
               <pre class="bg-light p-3 rounded small" style="max-height: 300px; overflow-y: auto;">{{ formatJsonResponse(cqlFile.uploadResult?.result) }}</pre>
             </div>
             }
           </div>
          }
        </div>
      </div>
      }

      <!-- Upload Progress -->
      @if (isUploading()) {
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <span>Uploading...</span>
          <span>{{ uploadProgress() | number:'1.0-0' }}%</span>
        </div>
        <div class="progress">
          <div class="progress-bar" role="progressbar" [style.width.%]="uploadProgress()"
            [attr.aria-valuenow]="uploadProgress()" aria-valuemin="0" aria-valuemax="100">
          </div>
        </div>
      </div>
      }

      <!-- Upload Button -->
      <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button type="button" class="btn btn-primary btn-lg" (click)="uploadBundles()"
          [disabled]="!hasEnabledFiles() || isUploading()">
          @if (isUploading()) {
          <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
          Uploading...
          } @else {
          <i class="bi bi-upload me-2"></i>Upload Bundles ({{ getEnabledFilesCount() }})
          }
        </button>
      </div>


       <!-- Reset Server (Developer Mode Only) -->
       @if (settingsService.settings().developer) {
       <div class="mt-4 pt-3 border-top">
         <h5 class="text-danger mb-2">Danger Zone
         </h5>
         <p class="text-muted mb-3">
           Permanently delete all resources from the FHIR server. This action cannot be undone.
         </p>
         <div class="dropdown">
           <button type="button" class="btn btn-outline-danger dropdown-toggle" data-bs-toggle="dropdown"
             aria-expanded="false" [disabled]="isExpunging() || isPurging()">
             @if (isExpunging() || isPurging()) {
               <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
               Resetting...
             } @else {
               <i class="bi bi-exclamation-triangle me-1"></i>Reset Server
             }
           </button>
           <ul class="dropdown-menu">
             <li>
               <button type="button" class="dropdown-item" (click)="showExpungeConfirmation()" [disabled]="isExpunging() || isPurging()">
                 @if (isExpunging()) {
                   <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                 } @else {
                   <i class="bi bi-trash me-2"></i>
                 }
                 Expunge (HAPI)
               </button>
             </li>
             <li>
               <button type="button" class="dropdown-item" (click)="showPurgeConfirmation()" [disabled]="isExpunging() || isPurging()">
                 @if (isPurging()) {
                   <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                 } @else {
                   <i class="bi bi-trash me-2"></i>
                 }
                 Purge All (WildFHIR)
               </button>
             </li>
           </ul>
         </div>
       </div>
       }
    </div>
  </div>
</div>

<!-- Bootstrap Modals -->
<!-- Expunge Confirmation Modal -->
@if (showExpungeModal()) {
<div class="modal fade show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Expunge</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to expunge all resources from the FHIR server?</p>
        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button #expungeConfirmButton type="button" class="btn btn-danger" (click)="confirmExpunge()">
          <i class="bi bi-trash me-1"></i>Expunge All Resources
        </button>
      </div>
    </div>
  </div>
</div>
}

<!-- Purge Confirmation Modal -->
@if (showPurgeModal()) {
<div class="modal fade show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Purge</h5>
        <button type="button" class="btn-close" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to purge all resources from the FHIR server?</p>
        <p class="text-danger"><strong>This action cannot be undone.</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button #purgeConfirmButton type="button" class="btn btn-danger" (click)="confirmPurge()">
          <i class="bi bi-trash me-1"></i>Purge All Resources
        </button>
      </div>
    </div>
  </div>
</div>
}

<!-- Result Modal -->
@if (showUploadModal()) {
<div class="modal fade show d-block" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header" [class.bg-success]="modalType() === 'success'" [class.bg-danger]="modalType() === 'error'" [class.bg-warning]="modalType() === 'warning'">
        <h5 class="modal-title text-white">
          @if (modalType() === 'success') {
            <i class="bi bi-check-circle me-2"></i>
          } @else if (modalType() === 'error') {
            <i class="bi bi-x-circle me-2"></i>
          } @else {
            <i class="bi bi-exclamation-triangle me-2"></i>
          }
          {{ modalTitle() }}
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeModal()"></button>
      </div>
      <div class="modal-body">
        <p>{{ modalMessage() }}</p>
      </div>
      <div class="modal-footer">
        <button #resultModalButton type="button" class="btn btn-primary" (click)="closeModal()">OK</button>
      </div>
    </div>
  </div>
</div>
}