<div class="container mt-5">
	<div class="row justify-content-center">
		<div class="col-md-8">
			<div class="card">
				<div class="card-header">
					<h2 class="card-title mb-0">Open a results file</h2>
					<!-- <p class="text-muted mb-0">Upload a results file or provide a URL to view CQL test results</p> -->
				</div>
				<div class="card-body">
					<!-- File Upload Section -->
					<div class="mb-4">
						<h5>Open Local File</h5>
						<div class="input-group">
							<input type="file" class="form-control" id="file-input" accept=".json"
								(change)="onFileSelected($event)" [disabled]="isLoading()">
							<!-- Action buttons shown when validation fails -->
							@if (validationErrors().length > 0 && selectedFile()) {
								<button id="clear-file-btn" class="btn btn-outline-secondary" type="button" (click)="clearSelectedFile()"
									[disabled]="isLoading()" title="Clear selected file">
									<i class="bi bi-x-circle"></i> Clear
								</button>
								<button id="retry-validation-btn" class="btn btn-outline-secondary" type="button" (click)="rerunValidation()"
									[disabled]="isLoading()" title="Rerun validation">
									<i class="bi bi-arrow-clockwise"></i> Retry
								</button>
							}
						</div>
						<div class="form-text">Select a JSON file containing CQL test results. It will <b>not</b> be uploaded to any server.</div>
					</div>

					<div class="text-center mb-4">
						<span class="text-muted">OR</span>
					</div>

					<!-- URL Input Section -->
					<div class="mb-4">
						<h5>Load from URL</h5>
						<div class="input-group">
							<input id="url-input" type="url" class="form-control" placeholder="https://example.com/results.json"
								[ngModel]="urlInput()" (ngModelChange)="urlInput.set($event)" [disabled]="isLoading()">
							<button id="url-load-button" class="btn btn-primary" type="button" (click)="onUrlSubmit()"
								[disabled]="isLoading() || !urlInput().trim()">
								Load
							</button>
							<button id="url-example-button" class="btn btn-outline-secondary" type="button" (click)="onLoadUrlExample()"
								[disabled]="isLoading()">
								Example
							</button>
						</div>
						<div class="form-text">Enter a URL to a JSON file containing CQL test results.</div>
					</div>

					<div class="text-center mb-4">
						<span class="text-muted">OR</span>
					</div>

					<!-- Index File Section -->
					<div class="mb-4">
						<h5>Load an Entire Index</h5>
						<div class="input-group mb-3">
							<input id="index-url-input" type="url" class="form-control" placeholder="https://example.com/index.json"
								[ngModel]="indexUrl()" (ngModelChange)="indexUrl.set($event)" [disabled]="isLoading() || indexLoading()">
							<button id="index-load-button" class="btn btn-primary" type="button" (click)="onLoadIndexFile()"
								[disabled]="isLoading() || indexLoading() || !indexUrl().trim()">
								Load Index
							</button>
							<button id="example-index-button" class="btn btn-outline-secondary" type="button" (click)="onLoadExampleIndex()"
								[disabled]="isLoading() || indexLoading()">
								Example
							</button>
						</div>
						<div class="form-text">Enter a URL to an index file in JSON format. It must contain an object with a "files" array of URLs to individual result files. For example, {{'{"files": ["...","..."]}'}}</div>
						
							<!-- Index Loading State -->
							@if (indexLoading()) {
								<div class="text-center">
									<div class="spinner-border spinner-border-sm text-primary" role="status">
										<span class="visually-hidden">Loading index...</span>
									</div>
									<span class="ms-2">Loading index file...</span>
								</div>
							}

							<!-- Index Error -->
							@if (indexError()) {
								<div class="alert alert-danger" role="alert">
									<h6 class="alert-heading">Index Error</h6>
									<p class="mb-0">{{ indexError() }}</p>
								</div>
							}

							<!-- Index Files List -->
							@if (indexFiles().length > 0) {
								<div class="mt-3">
									<div class="d-flex justify-content-between align-items-center mb-3">
										<h6 class="mb-0">Available Files:</h6>
										<button id="open-dashboard-btn" class="btn btn-primary" type="button" 
											(click)="onOpenDashboard()" [disabled]="isLoading()">
											<i class="bi bi-graph-up me-2"></i>Summary Dashboard & Comparison Matrix
										</button>
									</div>
									<div class="list-group">
										@for (filename of indexFiles(); track filename) {
											<div class="list-group-item d-flex justify-content-between align-items-center">
												<span class="text-truncate me-2" [title]="filename">
													<i class="bi bi-file-earmark-json me-2"></i>{{ filename }}
												</span>
												<button id="load-file-from-index-btn-{{ filename }}" class="btn btn-sm btn-outline-primary" type="button" 
													(click)="onLoadFileFromIndex(filename)" [disabled]="isLoading()">
													Load
												</button>
											</div>
										}
									</div>
								</div>
							}
					</div>

<hr>
					<!-- Settings Section -->
					<div class="mb-4">
						<h5>Settings</h5>
						<div class="form-check form-switch">
							<input class="form-check-input" type="checkbox" id="validate-schema-switch"
								[(ngModel)]="settingsService.settings().validateSchema"
								(ngModelChange)="onValidateSchemaChange()" [disabled]="isLoading()">
							<label class="form-check-label" for="validate-schema-switch">
								<i class="bi bi-check-circle me-1"></i>Validate against schema before loading
							</label>
						</div>
						<div class="form-text mt-2">
							<small class="text-muted">
								When enabled, files will be validated against the CQL test results schema before
								loading.
								Disable this for faster loading or when working with non-standard files.
							</small>
						</div>
					</div>

						<!-- Loading State -->
						@if (isLoading()) {
							<div class="text-center">
								<div class="spinner-border text-primary" role="status">
									<span class="visually-hidden">Loading...</span>
								</div>
								<p class="mt-2">Loading and validating results...</p>
							</div>
						}

						<!-- Error Messages -->
						@if (errorMessage()) {
							<div class="alert alert-danger" role="alert">
								<h6 class="alert-heading">Error</h6>
								<p class="mb-0">{{ errorMessage() }}</p>
							</div>
						}

						<!-- Validation Errors -->
						@if (validationErrors().length > 0) {
							<div class="alert alert-warning" role="alert">
								<h6 class="alert-heading">Validation Errors</h6>
								<p>The file does not conform to the expected schema:</p>
								<ul class="mb-0">
									@for (error of validationErrors(); track error) {
										<li>{{ error }}</li>
									}
								</ul>
							</div>
						}
				</div>
			</div>
		</div>
	</div>
</div>